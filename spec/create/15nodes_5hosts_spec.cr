require "./spec_helper"

describe Rcm::Create do
  describe "for 15 nodes on 5 hosts" do
    nodes = <<-EOF
      192.168.0.1:7001
      192.168.0.1:7002
      192.168.0.1:7003
      192.168.0.2:7001
      192.168.0.2:7002
      192.168.0.2:7003
      192.168.0.3:7001
      192.168.0.3:7002
      192.168.0.3:7003
      192.168.0.4:7001
      192.168.0.4:7002
      192.168.0.4:7003
      192.168.0.5:7001
      192.168.0.5:7002
      192.168.0.5:7003
      EOF

    it "generates rcm commands" do
      io = MemoryIO.new
      create = Rcm::Create.new(nodes.split)
      create.dryrun(io)
      io.to_s.should eq <<-EOF
        rcm -h '192.168.0.1' -p 7002 meet '192.168.0.1:7001'
        rcm -h '192.168.0.1' -p 7003 meet '192.168.0.1:7001'
        rcm -h '192.168.0.2' -p 7001 meet '192.168.0.1:7001'
        rcm -h '192.168.0.2' -p 7002 meet '192.168.0.1:7001'
        rcm -h '192.168.0.2' -p 7003 meet '192.168.0.1:7001'
        rcm -h '192.168.0.3' -p 7001 meet '192.168.0.1:7001'
        rcm -h '192.168.0.3' -p 7002 meet '192.168.0.1:7001'
        rcm -h '192.168.0.3' -p 7003 meet '192.168.0.1:7001'
        rcm -h '192.168.0.4' -p 7001 meet '192.168.0.1:7001'
        rcm -h '192.168.0.4' -p 7002 meet '192.168.0.1:7001'
        rcm -h '192.168.0.4' -p 7003 meet '192.168.0.1:7001'
        rcm -h '192.168.0.5' -p 7001 meet '192.168.0.1:7001'
        rcm -h '192.168.0.5' -p 7002 meet '192.168.0.1:7001'
        rcm -h '192.168.0.5' -p 7003 meet '192.168.0.1:7001'
        rcm -h '192.168.0.1' -p 7001 addslots '0-3276'
        rcm -h '192.168.0.2' -p 7001 addslots '3277-6553'
        rcm -h '192.168.0.3' -p 7001 addslots '6554-9830'
        rcm -h '192.168.0.4' -p 7001 addslots '9831-13107'
        rcm -h '192.168.0.5' -p 7001 addslots '13108-16383'
        sleep 1.0
        rcm -h '192.168.0.1' -p 7002 replicate '192.168.0.5:7001'
        rcm -h '192.168.0.1' -p 7003 replicate '192.168.0.4:7001'
        rcm -h '192.168.0.2' -p 7002 replicate '192.168.0.1:7001'
        rcm -h '192.168.0.2' -p 7003 replicate '192.168.0.5:7001'
        rcm -h '192.168.0.3' -p 7002 replicate '192.168.0.2:7001'
        rcm -h '192.168.0.3' -p 7003 replicate '192.168.0.1:7001'
        rcm -h '192.168.0.4' -p 7002 replicate '192.168.0.3:7001'
        rcm -h '192.168.0.4' -p 7003 replicate '192.168.0.2:7001'
        rcm -h '192.168.0.5' -p 7002 replicate '192.168.0.4:7001'
        rcm -h '192.168.0.5' -p 7003 replicate '192.168.0.3:7001'

        EOF
    end

    it "generates rcm commands with auth" do
      io = MemoryIO.new
      create = Rcm::Create.new(nodes.split, pass: "secret")
      create.dryrun(io)
      io.to_s.should eq <<-EOF
        rcm -a 'secret' -h '192.168.0.1' -p 7002 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.1' -p 7003 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.2' -p 7001 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.2' -p 7002 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.2' -p 7003 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.3' -p 7001 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.3' -p 7002 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.3' -p 7003 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.4' -p 7001 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.4' -p 7002 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.4' -p 7003 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.5' -p 7001 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.5' -p 7002 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.5' -p 7003 meet '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.1' -p 7001 addslots '0-3276'
        rcm -a 'secret' -h '192.168.0.2' -p 7001 addslots '3277-6553'
        rcm -a 'secret' -h '192.168.0.3' -p 7001 addslots '6554-9830'
        rcm -a 'secret' -h '192.168.0.4' -p 7001 addslots '9831-13107'
        rcm -a 'secret' -h '192.168.0.5' -p 7001 addslots '13108-16383'
        sleep 1.0
        rcm -a 'secret' -h '192.168.0.1' -p 7002 replicate '192.168.0.5:7001'
        rcm -a 'secret' -h '192.168.0.1' -p 7003 replicate '192.168.0.4:7001'
        rcm -a 'secret' -h '192.168.0.2' -p 7002 replicate '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.2' -p 7003 replicate '192.168.0.5:7001'
        rcm -a 'secret' -h '192.168.0.3' -p 7002 replicate '192.168.0.2:7001'
        rcm -a 'secret' -h '192.168.0.3' -p 7003 replicate '192.168.0.1:7001'
        rcm -a 'secret' -h '192.168.0.4' -p 7002 replicate '192.168.0.3:7001'
        rcm -a 'secret' -h '192.168.0.4' -p 7003 replicate '192.168.0.2:7001'
        rcm -a 'secret' -h '192.168.0.5' -p 7002 replicate '192.168.0.4:7001'
        rcm -a 'secret' -h '192.168.0.5' -p 7003 replicate '192.168.0.3:7001'

        EOF
    end

    # Rcm::Create
    #   for 15 nodes on 5 hosts
    #     creates 5 masters and 10 slaves with masters 5 option
    # ============================================================
    # find_master_for(192.168.0.1:7002)
    # ------------------------------------------------------------
    # # [slaves]
    # ------------------------------------------------------------
    # # [degree]
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [1, 0, 0, 4]
    #   192.168.0.2:7001: [0, 0, 0, 3]
    #   192.168.0.3:7001: [0, 0, 0, 2]
    #   192.168.0.4:7001: [0, 0, 0, 1]
    #   192.168.0.5:7001: [0, 0, 0, 0]
    # ------------------------------------------------------------
    # => 192.168.0.5:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.1:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: []
    #   192.168.0.2:7001: []
    #   192.168.0.3:7001: []
    #   192.168.0.4:7001: []
    #   192.168.0.5:7001: ["192.168.0.1:7002"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [1, 0, 0, 4]
    #   192.168.0.2:7001: [0, 0, 0, 3]
    #   192.168.0.3:7001: [0, 0, 0, 2]
    #   192.168.0.4:7001: [0, 0, 0, 1]
    #   192.168.0.5:7001: [0, 0, 1, 0]
    # ------------------------------------------------------------
    # => 192.168.0.4:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.2:7002)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: []
    #   192.168.0.2:7001: []
    #   192.168.0.3:7001: []
    #   192.168.0.4:7001: ["192.168.0.1:7003"]
    #   192.168.0.5:7001: ["192.168.0.1:7002"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.1, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 0, 0]
    #   192.168.0.2:7001: [1, 0, 0, 4]
    #   192.168.0.3:7001: [0, 0, 0, 3]
    #   192.168.0.4:7001: [0, 0, 0, 2]
    #   192.168.0.5:7001: [0, 0, 0, 1]
    # ------------------------------------------------------------
    # => 192.168.0.1:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.2:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: []
    #   192.168.0.3:7001: []
    #   192.168.0.4:7001: ["192.168.0.1:7003"]
    #   192.168.0.5:7001: ["192.168.0.1:7002"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.1, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 1, 0]
    #   192.168.0.2:7001: [1, 0, 0, 4]
    #   192.168.0.3:7001: [0, 0, 0, 3]
    #   192.168.0.4:7001: [0, 0, 0, 2]
    #   192.168.0.5:7001: [0, 0, 0, 1]
    # ------------------------------------------------------------
    # => 192.168.0.5:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.3:7002)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: []
    #   192.168.0.3:7001: []
    #   192.168.0.4:7001: ["192.168.0.1:7003"]
    #   192.168.0.5:7001: ["192.168.0.1:7002", "192.168.0.2:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.1, 192.168.0.5): 1
    #   (192.168.0.2, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 0, 1]
    #   192.168.0.2:7001: [0, 0, 0, 0]
    #   192.168.0.3:7001: [1, 0, 0, 4]
    #   192.168.0.4:7001: [0, 0, 0, 3]
    #   192.168.0.5:7001: [0, 1, 0, 2]
    # ------------------------------------------------------------
    # => 192.168.0.2:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.3:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: ["192.168.0.3:7002"]
    #   192.168.0.3:7001: []
    #   192.168.0.4:7001: ["192.168.0.1:7003"]
    #   192.168.0.5:7001: ["192.168.0.1:7002", "192.168.0.2:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.1, 192.168.0.5): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 0, 1]
    #   192.168.0.2:7001: [0, 0, 1, 0]
    #   192.168.0.3:7001: [1, 0, 0, 4]
    #   192.168.0.4:7001: [0, 0, 0, 3]
    #   192.168.0.5:7001: [0, 1, 0, 2]
    # ------------------------------------------------------------
    # => 192.168.0.1:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.4:7002)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002", "192.168.0.3:7003"]
    #   192.168.0.2:7001: ["192.168.0.3:7002"]
    #   192.168.0.3:7001: []
    #   192.168.0.4:7001: ["192.168.0.1:7003"]
    #   192.168.0.5:7001: ["192.168.0.1:7002", "192.168.0.2:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.1, 192.168.0.5): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 1, 1, 2]
    #   192.168.0.2:7001: [0, 0, 0, 1]
    #   192.168.0.3:7001: [0, 0, 0, 0]
    #   192.168.0.4:7001: [1, 0, 0, 4]
    #   192.168.0.5:7001: [0, 1, 0, 3]
    # ------------------------------------------------------------
    # => 192.168.0.3:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.4:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002", "192.168.0.3:7003"]
    #   192.168.0.2:7001: ["192.168.0.3:7002"]
    #   192.168.0.3:7001: ["192.168.0.4:7002"]
    #   192.168.0.4:7001: ["192.168.0.1:7003"]
    #   192.168.0.5:7001: ["192.168.0.1:7002", "192.168.0.2:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.1, 192.168.0.5): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.5): 1
    #   (192.168.0.3, 192.168.0.4): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 1, 1, 2]
    #   192.168.0.2:7001: [0, 0, 0, 1]
    #   192.168.0.3:7001: [0, 0, 1, 0]
    #   192.168.0.4:7001: [1, 0, 0, 4]
    #   192.168.0.5:7001: [0, 1, 0, 3]
    # ------------------------------------------------------------
    # => 192.168.0.2:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.5:7002)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002", "192.168.0.3:7003"]
    #   192.168.0.2:7001: ["192.168.0.3:7002", "192.168.0.4:7003"]
    #   192.168.0.3:7001: ["192.168.0.4:7002"]
    #   192.168.0.4:7001: ["192.168.0.1:7003"]
    #   192.168.0.5:7001: ["192.168.0.1:7002", "192.168.0.2:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.1, 192.168.0.5): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.5): 1
    #   (192.168.0.3, 192.168.0.4): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 1, 1, 3]
    #   192.168.0.2:7001: [0, 1, 1, 2]
    #   192.168.0.3:7001: [0, 0, 0, 1]
    #   192.168.0.4:7001: [0, 0, 0, 0]
    #   192.168.0.5:7001: [1, 1, 0, 4]
    # ------------------------------------------------------------
    # => 192.168.0.4:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.5:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002", "192.168.0.3:7003"]
    #   192.168.0.2:7001: ["192.168.0.3:7002", "192.168.0.4:7003"]
    #   192.168.0.3:7001: ["192.168.0.4:7002"]
    #   192.168.0.4:7001: ["192.168.0.1:7003", "192.168.0.5:7002"]
    #   192.168.0.5:7001: ["192.168.0.1:7002", "192.168.0.2:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.1, 192.168.0.5): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.5): 1
    #   (192.168.0.3, 192.168.0.4): 1
    #   (192.168.0.4, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 1, 1, 3]
    #   192.168.0.2:7001: [0, 1, 1, 2]
    #   192.168.0.3:7001: [0, 0, 0, 1]
    #   192.168.0.4:7001: [0, 1, 1, 0]
    #   192.168.0.5:7001: [1, 1, 0, 4]
    # ------------------------------------------------------------
    # => 192.168.0.3:7001

    it "creates 5 masters and 10 slaves with masters 5 option" do
      commands = Rcm::Create.new(nodes.split).commands
      commands.select(&.is_a?(Rcm::Command::Addslots)).size.should eq 5
      commands.select(&.is_a?(Rcm::Command::Replicate)).should eq([
        replicate("192.168.0.1:7002", "192.168.0.5:7001"),
        replicate("192.168.0.1:7003", "192.168.0.4:7001"),
        replicate("192.168.0.2:7002", "192.168.0.1:7001"),
        replicate("192.168.0.2:7003", "192.168.0.5:7001"),
        replicate("192.168.0.3:7002", "192.168.0.2:7001"),
        replicate("192.168.0.3:7003", "192.168.0.1:7001"),
        replicate("192.168.0.4:7002", "192.168.0.3:7001"),
        replicate("192.168.0.4:7003", "192.168.0.2:7001"),
        replicate("192.168.0.5:7002", "192.168.0.4:7001"),
        replicate("192.168.0.5:7003", "192.168.0.3:7001"),
      ])
    end

    # Rcm::Create
    #   for 15 nodes on 5 hosts
    #     creates 4 masters and 11 slaves with masters 4 option
    # ============================================================
    # find_master_for(192.168.0.1:7002)
    # ------------------------------------------------------------
    # # [slaves]
    # ------------------------------------------------------------
    # # [degree]
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [1, 0, 0, 3]
    #   192.168.0.2:7001: [0, 0, 0, 2]
    #   192.168.0.3:7001: [0, 0, 0, 1]
    #   192.168.0.4:7001: [0, 0, 0, 0]
    # ------------------------------------------------------------
    # => 192.168.0.4:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.1:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: []
    #   192.168.0.2:7001: []
    #   192.168.0.3:7001: []
    #   192.168.0.4:7001: ["192.168.0.1:7002"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.4): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [1, 0, 0, 3]
    #   192.168.0.2:7001: [0, 0, 0, 2]
    #   192.168.0.3:7001: [0, 0, 0, 1]
    #   192.168.0.4:7001: [0, 0, 1, 0]
    # ------------------------------------------------------------
    # => 192.168.0.3:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.2:7002)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: []
    #   192.168.0.2:7001: []
    #   192.168.0.3:7001: ["192.168.0.1:7003"]
    #   192.168.0.4:7001: ["192.168.0.1:7002"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 0, 0]
    #   192.168.0.2:7001: [1, 0, 0, 3]
    #   192.168.0.3:7001: [0, 0, 0, 2]
    #   192.168.0.4:7001: [0, 0, 0, 1]
    # ------------------------------------------------------------
    # => 192.168.0.1:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.2:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: []
    #   192.168.0.3:7001: ["192.168.0.1:7003"]
    #   192.168.0.4:7001: ["192.168.0.1:7002"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 1, 0]
    #   192.168.0.2:7001: [1, 0, 0, 3]
    #   192.168.0.3:7001: [0, 0, 0, 2]
    #   192.168.0.4:7001: [0, 0, 0, 1]
    # ------------------------------------------------------------
    # => 192.168.0.4:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.3:7002)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: []
    #   192.168.0.3:7001: ["192.168.0.1:7003"]
    #   192.168.0.4:7001: ["192.168.0.1:7002", "192.168.0.2:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.4): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 1, 1]
    #   192.168.0.2:7001: [0, 0, 0, 0]
    #   192.168.0.3:7001: [1, 0, 0, 3]
    #   192.168.0.4:7001: [0, 0, 0, 2]
    # ------------------------------------------------------------
    # => 192.168.0.2:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.3:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: ["192.168.0.3:7002"]
    #   192.168.0.3:7001: ["192.168.0.1:7003"]
    #   192.168.0.4:7001: ["192.168.0.1:7002", "192.168.0.2:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.4): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 1, 1]
    #   192.168.0.2:7001: [0, 0, 1, 0]
    #   192.168.0.3:7001: [1, 0, 0, 3]
    #   192.168.0.4:7001: [0, 0, 0, 2]
    # ------------------------------------------------------------
    # => 192.168.0.4:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.4:7002)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: ["192.168.0.3:7002"]
    #   192.168.0.3:7001: ["192.168.0.1:7003"]
    #   192.168.0.4:7001: ["192.168.0.1:7002", "192.168.0.2:7003", "192.168.0.3:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.4): 1
    #   (192.168.0.3, 192.168.0.4): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 1, 2]
    #   192.168.0.2:7001: [0, 0, 1, 1]
    #   192.168.0.3:7001: [0, 0, 1, 0]
    #   192.168.0.4:7001: [1, 1, 0, 3]
    # ------------------------------------------------------------
    # => 192.168.0.3:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.4:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: ["192.168.0.3:7002"]
    #   192.168.0.3:7001: ["192.168.0.1:7003", "192.168.0.4:7002"]
    #   192.168.0.4:7001: ["192.168.0.1:7002", "192.168.0.2:7003", "192.168.0.3:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.4): 1
    #   (192.168.0.3, 192.168.0.4): 2
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 1, 2]
    #   192.168.0.2:7001: [0, 0, 1, 1]
    #   192.168.0.3:7001: [0, 0, 2, 0]
    #   192.168.0.4:7001: [1, 1, 0, 3]
    # ------------------------------------------------------------
    # => 192.168.0.2:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.5:7001)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: ["192.168.0.3:7002", "192.168.0.4:7003"]
    #   192.168.0.3:7001: ["192.168.0.1:7003", "192.168.0.4:7002"]
    #   192.168.0.4:7001: ["192.168.0.1:7002", "192.168.0.2:7003", "192.168.0.3:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.4): 2
    #   (192.168.0.3, 192.168.0.4): 2
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 0, 3]
    #   192.168.0.2:7001: [0, 0, 0, 2]
    #   192.168.0.3:7001: [0, 0, 0, 1]
    #   192.168.0.4:7001: [0, 1, 0, 0]
    # ------------------------------------------------------------
    # => 192.168.0.3:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.5:7002)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: ["192.168.0.3:7002", "192.168.0.4:7003"]
    #   192.168.0.3:7001: ["192.168.0.1:7003", "192.168.0.4:7002", "192.168.0.5:7001"]
    #   192.168.0.4:7001: ["192.168.0.1:7002", "192.168.0.2:7003", "192.168.0.3:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.4): 2
    #   (192.168.0.3, 192.168.0.4): 2
    #   (192.168.0.3, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 0, 3]
    #   192.168.0.2:7001: [0, 0, 0, 2]
    #   192.168.0.3:7001: [0, 1, 1, 1]
    #   192.168.0.4:7001: [0, 1, 0, 0]
    # ------------------------------------------------------------
    # => 192.168.0.2:7001
    # 
    # ============================================================
    # find_master_for(192.168.0.5:7003)
    # ------------------------------------------------------------
    # # [slaves]
    #   192.168.0.1:7001: ["192.168.0.2:7002"]
    #   192.168.0.2:7001: ["192.168.0.3:7002", "192.168.0.4:7003", "192.168.0.5:7002"]
    #   192.168.0.3:7001: ["192.168.0.1:7003", "192.168.0.4:7002", "192.168.0.5:7001"]
    #   192.168.0.4:7001: ["192.168.0.1:7002", "192.168.0.2:7003", "192.168.0.3:7003"]
    # ------------------------------------------------------------
    # # [degree]
    #   (192.168.0.1, 192.168.0.2): 1
    #   (192.168.0.1, 192.168.0.3): 1
    #   (192.168.0.1, 192.168.0.4): 1
    #   (192.168.0.2, 192.168.0.3): 1
    #   (192.168.0.2, 192.168.0.4): 2
    #   (192.168.0.2, 192.168.0.5): 1
    #   (192.168.0.3, 192.168.0.4): 2
    #   (192.168.0.3, 192.168.0.5): 1
    # ------------------------------------------------------------
    #   192.168.0.1:7001: [0, 0, 0, 3]
    #   192.168.0.2:7001: [0, 1, 1, 2]
    #   192.168.0.3:7001: [0, 1, 1, 1]
    #   192.168.0.4:7001: [0, 1, 0, 0]
    # ------------------------------------------------------------
    # => 192.168.0.1:7001

    it "creates 4 masters and 11 slaves with masters 4 option" do
      commands = Rcm::Create.new(nodes.split, masters: 4).commands
      commands.select(&.is_a?(Rcm::Command::Addslots)).size.should eq 4
      commands.select(&.is_a?(Rcm::Command::Replicate)).should eq([
        replicate("192.168.0.1:7002", "192.168.0.4:7001"),
        replicate("192.168.0.1:7003", "192.168.0.3:7001"),
        replicate("192.168.0.2:7002", "192.168.0.1:7001"),
        replicate("192.168.0.2:7003", "192.168.0.4:7001"),
        replicate("192.168.0.3:7002", "192.168.0.2:7001"),
        replicate("192.168.0.3:7003", "192.168.0.4:7001"),
        replicate("192.168.0.4:7002", "192.168.0.3:7001"),
        replicate("192.168.0.4:7003", "192.168.0.2:7001"),
        replicate("192.168.0.5:7001", "192.168.0.3:7001"),
        replicate("192.168.0.5:7002", "192.168.0.2:7001"),
        replicate("192.168.0.5:7003", "192.168.0.1:7001"),
      ])
    end
  end
end
